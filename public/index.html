<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>MKE Pickup Alerts Signup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- Sticky site header -->
  <header class="site-header">
    <div class="site-header__inner">
      <div class="site-title">MKE Garbage Pickup Alerts</div>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT: TRUST / EXPLANATION -->
    <section class="info-panel">
      <h1>MKE Pickup Alerts</h1>
      <p class="tagline">
        Get a text the night before your City of Milwaukee garbage
        and/or recycling pickup!
      </p>

      <h2>What this does</h2>
      <p>
        We look up the official City of Milwaukee collection schedule for your
        address and:
      </p>
      <ul>
        <li>Send a reminder text the night before garbage and/or recycling pickup.</li>
        <li>Let you text <span class="pill pill-status">STATUS</span> any time to see your next pickup dates.</li>
        <li>Let you stop messages instantly with <span class="pill pill-cancel">STOP</span>.</li>
        <li>Let you request help with <span class="pill pill-status">HELP</span>.</li>
      </ul>

      <h2>How signup works</h2>
      <ol>
        <li>Enter your mobile number and Milwaukee address in the form on the right.</li>
        <li>Check the consent box (Terms + Privacy included).</li>
        <li>We validate your address against the city’s collection service.</li>
        <li>You’ll get a text asking you to confirm – reply <span class="pill pill-yes">YES</span> to turn alerts on.</li>
      </ol>
      <p class="info-disclaimer">
        If the address can’t be matched to a valid collection schedule, we’ll tell you instead of signing you up.
      </p>

      <h2>Texts you can send</h2>
      <ul>
        <li>
          <strong>Confirm alerts:</strong>
          reply <span class="pill pill-yes">YES</span> (or <span class="pill pill-yes">Y</span>) to the first message.
        </li>
        <li>
          <strong>Check your schedule:</strong>
          send <span class="pill pill-status">STATUS</span> to get your next pickup dates.
        </li>
        <li>
          <strong>Help:</strong>
          send <span class="pill pill-status">HELP</span> for info and support.
        </li>
        <li>
          <strong>Stop alerts:</strong>
          send <span class="pill pill-cancel">STOP</span> at any time to unsubscribe.
        </li>
      </ul>

      <p class="info-disclaimer">
        Your phone number is only used to send these pickup reminders and respond to your commands.
        Up to 4 msgs/month. Msg&data rates may apply. Reply STOP to unsubscribe, HELP for help.
      </p>
      <p class="info-disclaimer">
        No mobile information will be shared with third parties/affiliates for marketing/promotional purposes.
      </p>
    </section>

    <!-- RIGHT: SIGNUP BOX -->
    <div class="container">
      <h1>Sign Up For Alerts</h1>
      <p class="subtitle">
        Input your information to sign up for alerts.
      </p>

      <form id="signup-form">
        <div class="field">
          <label for="phone">Mobile phone number</label>
          <div class="phone-wrapper">
            <span class="phone-prefix">+1</span>
            <input type="tel" id="phone" name="phone" class="phone-input" placeholder="(414) 555-1234"
              autocomplete="tel" required />
          </div>
          <div class="help-text">
            US number, 10 digits.
          </div>
        </div>

        <div class="field">
          <label>Address (Milwaukee)</label>
          <div class="field-row">
            <input type="text" id="laddr" name="laddr" placeholder="1403" required />
            <select id="sdir" name="sdir">
              <option value="">–</option>
              <option value="N">N</option>
              <option value="S">S</option>
              <option value="E">E</option>
              <option value="W">W</option>
            </select>
            <select id="sname" name="sname" placeholder="Street Name" required></select>
            <select id="stype" name="stype" required></select>
          </div>
          <div class="help-text">
            Example: <strong>1403 E POTTER AV</strong> → 1403 / E / POTTER / AV.
          </div>
        </div>

        <!-- REQUIRED SMS CONSENT -->
        <div class="field consent-field">
          <label class="consent-label" for="sms-consent" style="display:flex; gap:10px; align-items:flex-start;">
            <input type="checkbox" id="sms-consent" name="sms_consent" required style="margin-top:4px;" />
            <span>
              I agree to receive automated text messages from <strong>MKE Garbage Pickup Alerts</strong> about trash &
              recycling pickup reminders and service updates for the address provided.
              <strong>Up to 4 msgs/month.</strong> Msg&data rates may apply. Reply <strong>STOP</strong> to unsubscribe,
              <strong>HELP</strong> for help.
              View <a href="terms.html">Terms</a> and <a href="privacy.html">Privacy Policy</a>.
              <br />
              <span style="font-size: 0.95em;">
                No mobile information will be shared with third parties/affiliates for marketing/promotional purposes.
              </span>
            </span>
          </label>
        </div>

        <button type="submit" id="submit-btn" disabled>Sign up for alerts</button>

        <div id="message" class="message"></div>
      </form>
    </div>
  </div>

  <!-- Simple footer -->
  <footer class="site-footer">
    <div class="site-footer__inner">
      <span class="site-footer__text">
        © 2025 JHAI LLC
      </span>
      <div class="site-footer__links">
        <a class="site-footer__link" href="privacy.html">Privacy Policy</a>
        <a class="site-footer__link" href="terms.html">Terms of Service</a>
        <a class="site-footer__link" href="mailto:jalioto@joesidea.com">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    const form = document.getElementById("signup-form");
    const messageEl = document.getElementById("message");
    const submitBtn = document.getElementById("submit-btn");
    const phoneInput = document.getElementById("phone");
    const laddrInput = document.getElementById("laddr");
    const sdirSelect = document.getElementById("sdir");
    const snameSelect = document.getElementById("sname");
    const stypeSelect = document.getElementById("stype");
    const consentCheckbox = document.getElementById("sms-consent");

    function showMessage(text, type) {
      messageEl.textContent = text;
      messageEl.className = "message " + type;
      messageEl.style.display = "block";
    }

    function getPhoneDigits() {
      return phoneInput.value.replace(/\D/g, "");
    }

    function isPhoneValid() {
      return getPhoneDigits().length === 10;
    }

    function areAddressFieldsValid() {
      const laddr = laddrInput.value.trim();
      const sname = snameSelect.value.trim();
      const stype = stypeSelect.value.trim();
      // sdir is optional
      return !!laddr && !!sname && !!stype;
    }

    function hasConsent() {
      return !!consentCheckbox && consentCheckbox.checked;
    }

    function updateButtonState() {
      const isValid = isPhoneValid() && areAddressFieldsValid() && hasConsent();
      submitBtn.disabled = !isValid;
    }

    // Format phone as (XXX) XXX-XXXX and enforce 10 digits
    phoneInput.addEventListener("input", () => {
      let digits = phoneInput.value.replace(/\D/g, "");

      if (digits.length > 10) digits = digits.slice(0, 10);

      let formatted = "";
      if (digits.length > 0) formatted = "(" + digits.slice(0, 3);
      if (digits.length >= 4) formatted += ") " + digits.slice(3, 6);
      if (digits.length >= 7) formatted += "-" + digits.slice(6, 10);

      phoneInput.value = formatted;
      updateButtonState();
    });

    // Revalidate when any address field changes
    laddrInput.addEventListener("input", updateButtonState);
    sdirSelect.addEventListener("change", updateButtonState);
    snameSelect.addEventListener("change", updateButtonState);
    stypeSelect.addEventListener("change", updateButtonState);
    consentCheckbox.addEventListener("change", updateButtonState);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      messageEl.style.display = "none";

      const rawPhoneDigits = getPhoneDigits();
      const laddr = laddrInput.value.trim();
      const sdir = sdirSelect.value.trim();
      const sname = snameSelect.value.trim();
      const stype = stypeSelect.value.trim();

      if (rawPhoneDigits.length !== 10) {
        showMessage("Please enter a valid 10-digit US phone number.", "error");
        updateButtonState();
        return;
      }

      if (!laddr || !sname || !stype) {
        showMessage("Please fill in your house number, street name, and street type.", "error");
        updateButtonState();
        return;
      }

      if (!hasConsent()) {
        showMessage("Please check the consent box to continue.", "error");
        updateButtonState();
        return;
      }

      // Build full address (faddr)
      const parts = [laddr];
      if (sdir) parts.push(sdir);
      parts.push(sname);
      parts.push(stype);
      const faddr = parts.join(" ");

      // Build E.164-style phone
      const phone = "+1" + rawPhoneDigits;

      const payload = {
        phone,
        laddr,
        sdir,
        sname,
        stype,
        faddr,
        sms_consent: true,
        consent_source: window.location.href,
      };

      submitBtn.disabled = true;
      submitBtn.textContent = "Signing you up...";

      try {
        const res = await fetch("/signup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok) {
          showMessage(
            "Got it! We sent you a text. Reply YES to confirm. Reply STOP to unsubscribe, HELP for help.",
            "success"
          );
          form.reset();
          updateButtonState();
        } else {
          const err = (data && data.error) || "Something went wrong. Please check your address and try again.";
          showMessage(err, "error");
        }
      } catch (err) {
        console.error("Signup error:", err);
        showMessage("Network error. Please check your connection and try again.", "error");
      } finally {
        submitBtn.textContent = "Sign up for alerts";
        updateButtonState();
      }
    });

    updateButtonState();
  </script>

  <!-- populate sname/stype from your JS module -->
  <script type="module" src="./main.js"></script>

</body>

</html>
